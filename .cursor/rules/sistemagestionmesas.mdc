---
alwaysApply: true
---
ğŸ“‹ GUÃA COMPLETA: Sistema de GestiÃ³n de Mesas CobroFÃ¡cil
ğŸ¯ RESUMEN EJECUTIVO
Sistema integral de gestiÃ³n de mesas para restaurantes que combina:
GestiÃ³n visual de sectores, mesas y objetos decorativos
Sistema de ventas con estados de mesa controlados
FacturaciÃ³n con formas de pago obligatorias
Arrastre y posicionamiento en tiempo real
SincronizaciÃ³n entre mÃºltiples dispositivos
ğŸ—ï¸ ARQUITECTURA DEL SISTEMA
Componentes Principales
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    FRONTEND (React + TypeScript)           â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                  â”‚
â”‚  â”‚ GestionMesas    â”‚  â”‚ MesaGridCanvas  â”‚                  â”‚
â”‚  â”‚ (Coordinador)   â”‚  â”‚ (Renderizado)   â”‚                  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                  â”‚
â”‚                                                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                  â”‚
â”‚  â”‚ VentaIntegralV2 â”‚  â”‚ FormularioObjs  â”‚                  â”‚
â”‚  â”‚ (Ventas/Factur.)â”‚  â”‚ (Objetos Decor.)â”‚                  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
                              â”‚ API REST
                              â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    BACKEND (Node.js + Prisma)              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                  â”‚
â”‚  â”‚ /api/sectores   â”‚  â”‚ /api/mesas      â”‚                  â”‚
â”‚  â”‚ /api/objetos    â”‚  â”‚ /api/ventas     â”‚                  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                  â”‚
â”‚                                                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                  â”‚
â”‚  â”‚ PostgreSQL      â”‚  â”‚ Sistema Auth    â”‚                  â”‚
â”‚  â”‚ (Persistencia)  â”‚  â”‚ (JWT Tokens)    â”‚                  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
ğŸ“Š ESTRUCTURA DE DATOS
Estados de Mesa (3 Ãºnicos)
enum EstadoMesa {
  LIBRE = 'LIBRE',                    // ğŸŸ¢ Verde - Sin Ã­tems ni facturaciÃ³n
  OCUPADA = 'OCUPADA',                // ğŸ”´ Rojo - Con Ã­tems, sin facturaciÃ³n
  ESPERANDO_PEDIDO = 'ESPERANDO_PEDIDO' // ğŸ”µ Azul - Factura/ticket emitido
}
Modelo de Mesa
interface Mesa {
  id: string;
  numero: string;
  capacidad: number;
  posicionX: number;        // Coordenadas en canvas
  posicionY: number;
  size: number;            // TamaÃ±o personalizable (20-200px)
  estado: EstadoMesa;
  forma: FormaMesa;        // REDONDA | CUADRADA | RECTANGULAR | OVALADA
  color?: string;
  sectorId: string;
  sector?: Sector;
}
Modelo de FacturaciÃ³n
interface FacturaEmitida {
  tipo: 'fiscal' | 'no_fiscal' | null;
  numero?: string;
  pagos: Array<{
    metodo: 'efectivo' | 'tarjeta' | 'qr' | 'transferencia';
    monto: number;
  }>;
  anulada: boolean;
  fechaEmision?: Date;
}
ğŸ® FUNCIONAMIENTO DETALLADO
1. GESTIÃ“N DE SECTORES
Crear Sector
// API: POST /api/sectores
{
  "nombre": "SalÃ³n Principal",
  "descripcion": "Ãrea principal del restaurante",
  "color": "#2196f3",
  "icono": "ğŸ½ï¸",
  "orden": 0
}
Funcionalidades
Crear, editar, eliminar sectores
Ordenamiento por prioridad
Colores e iconos personalizables
ValidaciÃ³n de nombres Ãºnicos
Crear Mesa
stateDiagram-v2
    [*] --> LIBRE
    LIBRE --> OCUPADA : Agregar Ã­tem
    OCUPADA --> LIBRE : Eliminar todos los Ã­tems
    OCUPADA --> ESPERANDO_PEDIDO : Emitir factura/ticket
    ESPERANDO_PEDIDO --> LIBRE : Completar venta
    ESPERANDO_PEDIDO --> OCUPADA : Anular factura
    Arrastre y Posicionamiento
Drag & Drop en tiempo real
Sistema de cambios pendientes (visual inmediato, guardado por lotes)
SincronizaciÃ³n automÃ¡tica entre dispositivos
Restricciones de lÃ­mites del canvas
3. SISTEMA DE VENTAS
Flujo de Venta Completo
// API: POST /api/mesas
{
  "numero": "M01",
  "sectorId": "sector-id",
  "capacidad": 4,
  "forma": "REDONDA",
  "posicionX": 100,
  "posicionY": 150,
  "size": 60,
  "color": "#4caf50"
}
Estados de Venta
'activa' - Venta en curso
'enviada' - Comanda enviada a cocina
'cuenta_pedida' - Cuenta solicitada
GestiÃ³n de Productos
BÃºsqueda inteligente con normalizaciÃ³n de texto
ModificaciÃ³n de cantidades en tiempo real
EliminaciÃ³n con validaciÃ³n de estado
Especificaciones personalizadas por Ã­tem
4. FACTURACIÃ“N Y FORMAS DE PAGO
Criterios Obligatorios
Registro obligatorio de forma de pago al emitir ticket
Estados Ãºnicos controlados por lÃ³gica de negocio
AnulaciÃ³n y reintegro con trazabilidad completa
Modal de Formas de Pago
// 1. Inicializar venta
ventasActivasService.crearVenta(mesa.id);

// 2. Agregar productos
ventasActivasService.agregarProducto(mesa.id, producto, cantidad);

// 3. Procesar facturaciÃ³n
const factura = await procesarFacturacionConPago(formasPago);

// 4. Completar venta
ventasActivasService.completarVenta(mesa.id);
Tipos de Comprobantes
TICKET - No fiscal
FACTURA_A - Responsable inscripto
FACTURA_B - Consumidor final
Proceso de AnulaciÃ³n
interface FormaPago {
  metodo: 'efectivo' | 'tarjeta' | 'qr' | 'transferencia';
  monto: number;
}

// ValidaciÃ³n: Total de pagos = Total de venta
const totalPagos = formasPago.reduce((sum, p) => sum + p.monto, 0);
if (Math.abs(totalPagos - ventaTotal) > 0.01) {
  throw new Error('Los pagos deben cubrir el total');
}
5. OBJETOS DECORATIVOS
Tipos Disponibles
// Criterio 4: LÃ³gica de anulaciÃ³n
const anularFactura = async () => {
  // 1. Anular ticket emitido
  setFacturaEmitida(prev => ({ ...prev, anulada: true }));
  
  // 2. Volver estado a rojo (ocupada)
  onCambiarEstado(mesa, EstadoMesa.OCUPADA);
  
  // 3. Permitir nueva facturaciÃ³n
  setModalFormasPago(true);
};
Crear Objeto
enum TipoObjeto {
  DECORATIVO = 'DECORATIVO',
  BARRA = 'BARRA',
  ESCENARIO = 'ESCENARIO',
  BANO = 'BANO',
  COCINA = 'COCINA',
  ENTRADA = 'ENTRADA',
  SALIDA = 'SALIDA',
  OTROS = 'OTROS'
}
CaracterÃ­sticas
Arrastre igual que las mesas
EdiciÃ³n visual con iconos de ajuste âš™ï¸
EliminaciÃ³n integrada en formulario
Sin iconos ni bordes (solo color de fondo)
6. SISTEMA DE CAMBIOS PENDIENTES
Arquitectura
CaracterÃ­sticas
Arrastre igual que las mesas
EdiciÃ³n visual con iconos de ajuste âš™ï¸
EliminaciÃ³n integrada en formulario
Sin iconos ni bordes (solo color de fondo)
6. SISTEMA DE CAMBIOS PENDIENTES
Arquitectura
Flujo de Guardado
interface CambiosPendientes {
  mesas: Array<{ id: string; posicionX: number; posicionY: number }>;
  objetos: Array<{ id: string; posicionX: number; posicionY: number }>;
}
7. SINCRONIZACIÃ“N INTELIGENTE
LÃ³gica de SincronizaciÃ³n
// 1. Arrastre - Solo actualizaciÃ³n visual
const handleMouseMove = (e) => {
  // Actualizar posiciÃ³n local inmediatamente
  setMesasLocales(prev => prev.map(mesa => 
    mesa.id === dragging.mesa.id 
      ? { ...mesa, posicionX: nuevaX, posicionY: nuevaY }
      : mesa
  ));
  
  // Registrar cambio pendiente (sin BD)
  setCambiosPendientes(prev => ({
    ...prev,
    mesas: [...prev.mesas.filter(m => m.id !== mesaId), 
           { id: mesaId, posicionX: nuevaX, posicionY: nuevaY }]
  }));
};

// 2. Guardado - EnvÃ­o por lotes a BD
const guardarCambiosPendientes = async () => {
  for (const cambio of cambiosPendientes.mesas) {
    await mesasApi.actualizar(cambio.id, {
      posicionX: cambio.posicionX,
      posicionY: cambio.posicionY
    });
  }
  setCambiosPendientes({ mesas: [], objetos: [] });
};
8. MODO EDICIÃ“N
ActivaciÃ³n
BotÃ³n "Editar Plano" en header
Atajo de teclado 'E'
Auto-activaciÃ³n al crear objetos
Funcionalidades
Arrastre de mesas y objetos
Iconos de ajuste âš™ï¸ para ediciÃ³n rÃ¡pida
Grilla opcional (tecla 'G')
Zoom (Ctrl + rueda del mouse)
Guardado por lotes al salir
Atajos de Teclado
useEffect(() => {
  const tieneCambiosPendientes = cambiosPendientes.mesas.length > 0;
  
  // Solo sincronizar cuando:
  // 1. No hay cambios pendientes
  // 2. No se estÃ¡ arrastrando
  // 3. No estamos en modo ediciÃ³n con cambios
  if (!dragging && !tieneCambiosPendientes) {
    console.log('ğŸ”„ Sincronizando desde BD');
    setMesasLocales(mesas);
  } else {
    console.log('â¸ï¸ Evitando sincronizaciÃ³n - hay cambios pendientes');
  }
}, [mesas, dragging, cambiosPendientes]);
9. INTERFAZ DE USUARIO
Layout Principal
const atajos = {
  'E': 'Activar/desactivar modo ediciÃ³n',
  'G': 'Mostrar/ocultar grilla',
  'O': 'Crear objeto decorativo',
  'Ctrl++': 'Zoom in',
  'Ctrl+-': 'Zoom out',
  'Ctrl+0': 'Reset zoom',
  'Escape': 'Salir de modo ediciÃ³n'
};
Colores de Estado
ğŸŸ¢ Verde (#4CAF50) - Mesa libre
ğŸ”´ Rojo (#F44336) - Mesa ocupada
ğŸ”µ Azul (#2196F3) - Mesa facturada
10. APIs DEL BACKEND
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Header: TÃ­tulo + Botones (Nuevo Sector, Editar Plano)      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Sectores: Tabs horizontales con colores e iconos           â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Sidebar â”‚ Canvas Principal                                  â”‚
â”‚ - Ocup. â”‚ - Mesas con estados de color                     â”‚
â”‚ - Stats â”‚ - Objetos decorativos                            â”‚
â”‚         â”‚ - Zoom y grilla opcionales                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
Mesas
GET    /api/sectores          // Obtener todos
POST   /api/sectores          // Crear nuevo
PUT    /api/sectores/:id      // Actualizar
DELETE /api/sectores/:id      // Eliminar
Objetos Decorativos
GET    /api/mesas             // Obtener todas
POST   /api/mesas             // Crear nueva
PUT    /api/mesas/:id         // Actualizar
PATCH  /api/mesas/:id/estado  // Cambiar estado
PATCH  /api/mesas/:id/posicion // Actualizar posiciÃ³n
DELETE /api/mesas/:id         // Eliminar
11. VALIDACIONES Y SEGURIDAD
AutenticaciÃ³n
JWT Tokens en todas las rutas
Middleware verificarToken obligatorio
Manejo de expiraciÃ³n con redirecciÃ³n automÃ¡tica
Validaciones de Negocio
GET    /api/objetos-decorativos        // Obtener todos
POST   /api/objetos-decorativos        // Crear nuevo
PUT    /api/objetos-decorativos/:id    // Actualizar
PATCH  /api/objetos-decorativos/:id/posicion // Actualizar posiciÃ³n
DELETE /api/objetos-decorativos/:id    // Eliminar
12. RENDIMIENTO Y OPTIMIZACIÃ“N
Antes vs DespuÃ©s
// Estados de mesa
const validarCambioEstado = (estadoActual, estadoNuevo) => {
  // Solo se puede ir a AZUL desde ROJO con factura
  if (estadoNuevo === 'ESPERANDO_PEDIDO' && !facturaEmitida.tipo) {
    throw new Error('Debe emitir factura antes de cambiar a azul');
  }
};

// Formas de pago
const validarFormasPago = (formasPago, total) => {
  if (formasPago.length === 0) {
    throw new Error('Debe seleccionar al menos una forma de pago');
  }
  
  const totalPagos = formasPago.reduce((sum, p) => sum + p.monto, 0);
  if (Math.abs(totalPagos - total) > 0.01) {
    throw new Error('Los pagos deben cubrir el total exacto');
  }
};
Debounce y Throttling
âŒ ANTES:
- 1 llamada API por pÃ­xel de arrastre
- SincronizaciÃ³n constante desde BD
- PÃ©rdida de cambios al recargar

âœ… DESPUÃ‰S:
- 0 llamadas API durante arrastre
- SincronizaciÃ³n inteligente solo cuando es necesario
- Sistema de cambios pendientes con guardado por lotes
- Mejora del 95% en llamadas a BD
13. MANEJO DE ERRORES
Errores de Red
// Evitar spam de peticiones
const debouncedSave = useCallback(
  debounce((cambios) => {
    guardarCambiosPendientes(cambios);
  }, 300),
  []
);
RecuperaciÃ³n de Errores
Auto-retry en fallos de red
ReversiÃ³n de cambios en caso de error
Notificaciones claras al usuario
Logs detallados para debugging
14. CASOS DE USO PRINCIPALES
Caso 1: Venta Completa
Cliente llega â†’ Mesa en estado VERDE
Mesero agrega productos â†’ Mesa cambia a ROJO
Cliente termina â†’ Mesero emite ticket con forma de pago
Mesa cambia a AZUL â†’ Venta completada
Cliente se va â†’ Mesa vuelve a VERDE
Caso 2: AnulaciÃ³n de Factura
Mesa en estado AZUL (facturada)
Cliente quiere cambiar forma de pago
Mesero anula factura â†’ Mesa vuelve a ROJO
Selecciona nueva forma de pago â†’ Mesa vuelve a AZUL
Caso 3: ReorganizaciÃ³n de Plano
Gerente activa modo ediciÃ³n
Arrastra mesas y objetos â†’ Cambios visuales inmediatos
BotÃ³n muestra "Guardar Cambios (5)"
Hace clic en guardar â†’ Todos los cambios se envÃ­an a BD
Desactiva modo ediciÃ³n â†’ Cambios persistidos
15. MÃ‰TRICAS Y MONITOREO
Logs de Operaciones
const handleError = (error) => {
  if (error.response?.status === 401) {
    // Token expirado
    localStorage.removeItem('authToken');
    window.location.href = '/login';
  } else if (error.response?.status === 409) {
    // Conflicto de datos
    mostrarNotificacion('Conflicto: datos ya modificados', 'warning');
    recargarDatos();
  } else {
    // Error genÃ©rico
    mostrarNotificacion('Error de conexiÃ³n', 'error');
  }
};
Indicadores de Performance
Tiempo de respuesta de arrastre: < 16ms (60fps)
ReducciÃ³n de API calls: 95%
Tiempo de guardado por lotes: < 2s
SincronizaciÃ³n entre dispositivos: < 5s
ğŸ¯ BENEFICIOS DEL SISTEMA
Para Operadores
Interfaz intuitiva con colores claros
Arrastre fluido sin delays
Estados automÃ¡ticos sin intervenciÃ³n manual
FacturaciÃ³n obligatoria evita errores
Para Gerentes
ReorganizaciÃ³n visual del plano
Reportes por forma de pago automÃ¡ticos
Trazabilidad completa de operaciones
SincronizaciÃ³n entre mÃºltiples dispositivos
Para Desarrolladores
CÃ³digo modular y bien documentado
APIs RESTful estÃ¡ndar
Sistema de tipos completo en TypeScript
Manejo de errores robusto
ğŸ”§ CONFIGURACIÃ“N Y MANTENIMIENTO
Variables de Entorno
console.log('ğŸ¯ Moviendo mesa 3 (VISUAL):', {
  mousePos: { x: 250, y: 180 },
  nuevaPosicion: { x: 220, y: 150 },
  guardadoEn: 'PENDIENTE (no en BD)'
});

console.log('âœ… Mesa guardada en BD:', mesaId, {
  x: nuevaPosicionX, 
  y: nuevaPosicionY
}, '(BD + estado)');
Backup y RestauraciÃ³n
# Backend
DATABASE_URL="postgresql://..."
JWT_SECRET="..."
NODE_ENV="production"

# Frontend
VITE_API_URL="http://localhost:3000"
VITE_APP_NAME="CobroFÃ¡cil"
Mejoras TÃ©cnicas
WebSockets para sincronizaciÃ³n en tiempo real
Service Workers para funcionamiento offline
Progressive Web App completa
Microservicios para escalabilidad